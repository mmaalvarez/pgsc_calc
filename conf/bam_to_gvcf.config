params {
    // BAM-to-gVCF reference files (required when input is a BAM sample table)
    bam2gvcf_fasta            = null   // Reference FASTA; .fai, .pac, .ann, .amb, .0123, .bwt.2bit.64 must sit alongside
    bam2gvcf_dict             = null   // Sequence dictionary (.dict)
    bam2gvcf_dbsnp            = null   // dbSNP VCF (.vcf.gz); .tbi must sit alongside
    bam2gvcf_calling_regions  = null   // Calling regions BED (.bed.gz); .tbi must sit alongside
    bam2gvcf_contig_map       = null   // contig_mappings.txt
    gdc_token                 = null   // GDC token file (only needed for remote downloads)
    bam2gvcf_run_metrics      = true   // Set false to skip WGS metrics + flagstat
}

process {
    withName: 'LINK_LOCAL_BAM' {
        container = 'docker.io/broadinstitute/gatk:4.5.0.0'
        cpus   = 1
        memory = '500 MB'
        time   = '15m'
    }
    withName: 'GDC_DOWNLOAD' {
        container = 'docker.io/cassisbonbon/gdcclient:v1.0'
        cpus      = 8
        memory    = { "${45 + 5*(task.attempt-1)} GB" }
        queue     = 'downloads'
        time      = { 48.h }
        maxRetries = 2
    }
    withName: 'REF_GENOME_RECOGNITION' {
        container = 'quay.io/biocontainers/pysam:0.15.2--py38hbab3036_7'
        cpus   = 1
        memory = { "${500 + 500*(task.attempt-1)} MB" }
        time   = { 1.h * task.attempt }
    }
    withName: 'REALIGN_BWA_MEM2' {
        container = 'docker.io/danielnaro/bwa_mem2_with_samtools:v3'
        cpus   = 30
        queue  = 'normal_prio_unlim'
        memory = { "${150 + 20*(task.attempt-1)} GB" }
        time   = { 48.h * task.attempt }
    }
    withName: 'COORDINATE_SORT' {
        container  = 'docker.io/danielnaro/bwa_mem2_with_samtools:v3'
        cpus       = 4
        queue      = 'normal_prio_long'
        memory     = { "${16 + 8*(task.attempt-1)} GB" }
        time       = { 6.h * task.attempt }
        maxRetries = 3
    }
    withName: 'PREPARE_COHORT_REF' {
        container = 'docker.io/cassisbonbon/preparereferencegenome:v2.0'
        cpus   = 2
        memory = { "${12 + 4*(task.attempt-1)} GB" }
        time   = { 2.h * task.attempt }
    }
    withName: 'FILTER_DBSNP' {
        container = 'quay.io/biocontainers/bcftools:1.17--haef29d1_0'
        cpus   = 2
        memory = { "${4 + 4*(task.attempt-1)} GB" }
        time   = { 3.h * task.attempt }
    }
    withName: 'DEDUP_BQSR' {
        container = 'docker.io/broadinstitute/gatk:4.5.0.0'
        cpus   = 8
        queue  = 'normal_prio_long'
        memory = { "${150 + 10*(task.attempt-1)} GB" }
        time   = { 48.h }
    }
    withName: 'WGS_METRICS' {
        container = 'https://depot.galaxyproject.org/singularity/gridss:2.11.1--hdfd78af_1'
        cpus       = 4
        memory     = { "${18 + 5*(task.attempt-1)} GB" }
        time       = { 4.h * task.attempt }
        maxRetries = 4
        errorStrategy = { task.attempt <= 3 ? 'retry' : 'ignore' }
    }
    withName: 'FLAGSTAT' {
        container = 'https://depot.galaxyproject.org/singularity/sambamba:1.0--h98b6b92_0'
        cpus   = 2
        memory = { "${500 + 500*(task.attempt-1)} MB" }
        time   = { 3.h * task.attempt }
    }
    withName: 'SPLIT_CALLING_REGIONS' {
        container = 'docker.io/broadinstitute/gatk:4.5.0.0'
        cpus   = 1
        memory = { "${2 + 1*(task.attempt-1)} GB" }
        time   = { 1.h * task.attempt }
    }
    withName: 'HAPLOTYPECALLER' {
        container = 'docker.io/broadinstitute/gatk:4.5.0.0'
        cpus   = 8
        memory = { "${10 + 2*(task.attempt-1)} GB" }
        queue  = 'normal_prio_long'
        time   = { 12.h * task.attempt }
    }
    withName: 'GATHER_GVCFS' {
        container = 'docker.io/broadinstitute/gatk:4.5.0.0'
        cpus   = 2
        memory = { "${16 + 4*(task.attempt-1)} GB" }
        time   = { 6.h * task.attempt }
    }
    withName: 'JOINT_GENOTYPE' {
        container  = 'docker.io/broadinstitute/gatk:4.5.0.0'
        cpus       = 4
        memory     = { "${20 + 16*(task.attempt-1)} GB" }
        queue      = 'normal_prio_unlim'
        time       = { "${72 + 24*(task.attempt-1)} hours" }
        maxRetries = 2
    }
    withName: 'GENERATE_SAMPLESHEET' {
        container = 'docker.io/broadinstitute/gatk:4.5.0.0'
        cpus   = 1
        memory = '1 GB'
        time   = '30m'
    }
}
